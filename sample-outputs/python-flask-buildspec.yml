# Flask/FastAPI Python í”„ë¡œì íŠ¸ìš© AWS CodeBuild buildspec.yml
# Otto Handlerì—ì„œ ìžë™ ìƒì„±ë¨

version: '0.2'

# Flask/FastAPI í™˜ê²½ë³€ìˆ˜
env:
  variables:
    # Python ê¸°ë³¸ ì„¤ì •
    PYTHONPATH: '.'
    PYTHON_VERSION: '3.9'
    PYTHONUNBUFFERED: '1'

    # Flask ì„¤ì •
    FLASK_APP: 'app.py'
    FLASK_ENV: 'production'
    FLASK_RUN_HOST: '0.0.0.0'
    FLASK_RUN_PORT: '5000'

    # ë˜ëŠ” FastAPI ì„¤ì •
    # FASTAPI_ENV: 'production'
    # UVICORN_HOST: '0.0.0.0'
    # UVICORN_PORT: '8000'

    # ë°ì´í„°ë² ì´ìŠ¤
    DATABASE_URL: 'sqlite:///production.db'
    # DATABASE_URL: 'postgresql://user:pass@localhost/flask_app'

    # ê¸°íƒ€
    SECRET_KEY: '$FLASK_SECRET_KEY'
    JWT_SECRET_KEY: '$JWT_SECRET_KEY'

phases:
  # Python í™˜ê²½ ë° ì˜ì¡´ì„± ì„¤ì¹˜
  install:
    commands:
      - echo "ðŸ Flask/FastAPI í™˜ê²½ ì„¤ì •..."
      - python3 --version
      - pip3 --version

      # ê°€ìƒí™˜ê²½ ìƒì„± ë° í™œì„±í™”
      - echo "ðŸ—ï¸  ê°€ìƒí™˜ê²½ ì„¤ì •..."
      - python3 -m venv venv
      - source venv/bin/activate
      - which python
      - which pip

      # ê¸°ë³¸ íŒ¨í‚¤ì§€ ì—…ê·¸ë ˆì´ë“œ
      - echo "â¬†ï¸  pip ì—…ê·¸ë ˆì´ë“œ..."
      - pip install --upgrade pip setuptools wheel

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - echo "ðŸ“¦ í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜..."
      - pip install -r requirements.txt

      # ê°œë°œ ë° í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„±
      - echo "ðŸ§ª í…ŒìŠ¤íŠ¸ ë„êµ¬ ì„¤ì¹˜..."
      - pip install pytest pytest-flask pytest-cov
      - pip install flake8 black mypy
      - pip install gunicorn uvicorn[standard]  # WSGI/ASGI ì„œë²„

      - echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

  # ì‚¬ì „ ë¹Œë“œ ì„¤ì •
  pre_build:
    commands:
      - echo "ðŸ”§ ì‚¬ì „ ë¹Œë“œ ì„¤ì •..."
      - source venv/bin/activate

      # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
      - echo "ðŸ§¹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬..."
      - flake8 . --count --max-line-length=88 --show-source --statistics
      - black --check --diff .
      - mypy . --ignore-missing-imports || true

      # Flask ì•± ì²´í¬ (Flaskì¸ ê²½ìš°)
      - echo "ðŸ” Flask ì•± ê²€ì¦..."
      - flask --version
      - python -c "from app import app; print('Flask app import successful')"

      # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ìžˆëŠ” ê²½ìš°)
      - echo "ðŸ—ƒï¸  ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”..."
      - flask db upgrade || echo "No migrations found"

      - echo "âœ… ì‚¬ì „ ë¹Œë“œ ì™„ë£Œ"

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  build:
    commands:
      - echo "ðŸ§ª Flask/FastAPI ì•± í…ŒìŠ¤íŠ¸..."
      - source venv/bin/activate

      # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      - export FLASK_ENV=testing
      - export TESTING=true

      # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - echo "ðŸ”¬ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
      - python -m pytest tests/ -v --tb=short
      - python -m pytest tests/ --cov=app --cov-report=xml --cov-report=html

      # API í…ŒìŠ¤íŠ¸ (ìžˆëŠ” ê²½ìš°)
      - echo "ðŸŒ API í…ŒìŠ¤íŠ¸..."
      - python -m pytest tests/test_api.py -v || echo "No API tests found"

      # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ê°„ë‹¨í•œ)
      - echo "âš¡ ê°„ë‹¨í•œ ì„±ëŠ¥ ì²´í¬..."
      - python -c "
        import time
        from app import app
        with app.test_client() as client:
            start = time.time()
            response = client.get('/')
            end = time.time()
            print(f'Health check response time: {end-start:.3f}s')
            print(f'Status code: {response.status_code}')
        " || echo "Performance check skipped"

      - echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

  # ë¹Œë“œ í›„ íŒ¨í‚¤ì§•
  post_build:
    commands:
      - echo "ðŸ“¦ ë°°í¬ íŒ¨í‚¤ì§•..."
      - source venv/bin/activate

      # requirements.txt ì—…ë°ì´íŠ¸
      - echo "ðŸ“ requirements.txt ì—…ë°ì´íŠ¸..."
      - pip freeze > requirements-freeze.txt

      # í”„ë¡œë•ì…˜ìš© ì„¤ì • íŒŒì¼ ìƒì„±
      - echo "âš™ï¸  í”„ë¡œë•ì…˜ ì„¤ì • ìƒì„±..."
      - echo "web: gunicorn app:app --bind 0.0.0.0:\$PORT --workers 4" > Procfile
      - echo "python-3.9.18" > runtime.txt

      # Docker ì„¤ì • (ì„ íƒì )
      - echo "ðŸ³ Docker ì„¤ì •..."
      - cat > Dockerfile << 'EOF'
        FROM python:3.9-slim
        WORKDIR /app
        COPY requirements.txt .
        RUN pip install -r requirements.txt
        COPY . .
        CMD ["gunicorn", "app:app", "--bind", "0.0.0.0:8000"]
        EOF

      # ë°°í¬ ì•„ì¹´ì´ë¸Œ ìƒì„±
      - echo "ðŸ—œï¸  ë°°í¬ ì•„ì¹´ì´ë¸Œ ìƒì„±..."
      - tar -czf flask-app-$(date +%Y%m%d%H%M%S).tar.gz \
          --exclude='tests' \
          --exclude='.git' \
          --exclude='__pycache__' \
          --exclude='.pytest_cache' \
          --exclude='htmlcov' \
          .

      - echo "âœ… íŒ¨í‚¤ì§• ì™„ë£Œ"

# ë°°í¬ ì•„í‹°íŒ©íŠ¸
artifacts:
  files:
    # ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼
    - 'app.py'
    - 'requirements.txt'
    - 'requirements-freeze.txt'
    - 'Procfile'
    - 'runtime.txt'
    - 'Dockerfile'

    # ì„¤ì • ë° í…œí”Œë¦¿
    - 'templates/**/*'
    - 'static/**/*'
    - 'instance/**/*'

    # ë°ì´í„°ë² ì´ìŠ¤ (SQLiteì¸ ê²½ìš°)
    - '*.db'
    - 'migrations/**/*'

    # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë° ë³´ê³ ì„œ
    - 'coverage.xml'
    - 'htmlcov/**/*'

    # ë°°í¬ íŒŒì¼
    - 'flask-app-*.tar.gz'
    - 'venv/**/*'  # ê°€ìƒí™˜ê²½ í¬í•¨ (ì„ íƒì )

  name: 'FlaskPythonAppArtifacts'

# ë¹Œë“œ ìºì‹œ ì„¤ì •
cache:
  paths:
    # pip ìºì‹œ
    - '/root/.cache/pip/**/*'
    - '$HOME/.cache/pip/**/*'

    # Python ìºì‹œ
    - '__pycache__/**/*'
    - '.pytest_cache/**/*'
    - '.mypy_cache/**/*'

    # ê°€ìƒí™˜ê²½ ìºì‹œ (ì£¼ì˜: ê²½ë¡œ ë³€ê²½ ì‹œ ìž¬ìƒì„±)
    - 'venv/**/*'

    # ë°ì´í„°ë² ì´ìŠ¤ ìºì‹œ (ê°œë°œìš©)
    - '*.db'