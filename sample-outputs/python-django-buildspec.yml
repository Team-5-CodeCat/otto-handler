# Django/Python í”„ë¡œì íŠ¸ìš© AWS CodeBuild buildspec.yml
# Otto Handlerì—ì„œ ìë™ ìƒì„±ë¨

version: '0.2'

# Python í”„ë¡œì íŠ¸ í™˜ê²½ë³€ìˆ˜
env:
  variables:
    # Python ê¸°ë³¸ ì„¤ì •
    PYTHONPATH: '/usr/local/lib/python3.9/site-packages'
    PYTHON_VERSION: '3.9'
    PYTHONUNBUFFERED: '1'

    # Django ì„¤ì •
    DJANGO_SETTINGS_MODULE: 'myproject.settings.production'
    DJANGO_SECRET_KEY: '$DJANGO_SECRET_KEY'

    # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
    DATABASE_URL: 'postgresql://user:pass@localhost/db'
    REDIS_URL: 'redis://localhost:6379'

    # ê¸°íƒ€ í™˜ê²½
    DEBUG: 'False'
    ALLOWED_HOSTS: '.amazonaws.com,.elasticbeanstalk.com'

# ë¹Œë“œ ë‹¨ê³„ë“¤
phases:
  # ì˜ì¡´ì„± ì„¤ì¹˜ ë° í™˜ê²½ ì„¤ì •
  install:
    run-as: root
    commands:
      - echo "ğŸ Python í™˜ê²½ ì„¤ì • ì‹œì‘..."
      - python3 --version
      - pip3 --version

      # ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
      - echo "ğŸ“¦ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
      - apt-get update -y
      - apt-get install -y postgresql-client redis-tools
      - apt-get install -y python3-dev python3-pip python3-venv

      # Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - echo "ğŸ”§ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
      - pip3 install --upgrade pip setuptools wheel
      - pip3 install -r requirements.txt
      - pip3 install pytest pytest-cov pytest-django
      - pip3 install flake8 black mypy bandit
      - pip3 install gunicorn whitenoise

      - echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

  # ë¹Œë“œ ì „ ì¤€ë¹„ ì‘ì—…
  pre_build:
    commands:
      - echo "ğŸ” ì‚¬ì „ ë¹Œë“œ ê²€ì‚¬ ì‹œì‘..."

      # Django í”„ë¡œì íŠ¸ ì²´í¬
      - echo "Django ì„¤ì • ê²€ì¦..."
      - python manage.py check --deploy
      - python manage.py check --settings=myproject.settings.production

      # ì •ì  íŒŒì¼ ìˆ˜ì§‘
      - echo "ğŸ“ ì •ì  íŒŒì¼ ìˆ˜ì§‘..."
      - python manage.py collectstatic --noinput --clear

      # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
      - echo "ğŸ§¹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬..."
      - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      - black --check --diff .
      - mypy . --ignore-missing-imports
      - bandit -r . -f json -o bandit-report.json

      - echo "âœ… ì‚¬ì „ ë¹Œë“œ ì™„ë£Œ"

  # ë©”ì¸ ë¹Œë“œ ë‹¨ê³„
  build:
    commands:
      - echo "ğŸš€ Python ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì‹œì‘..."

      # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (í…ŒìŠ¤íŠ¸ìš©)
      - echo "ğŸ—ƒï¸  í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •..."
      - python manage.py makemigrations --dry-run --check

      # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
      - python -m pytest tests/ --verbose --tb=short
      - python -m pytest tests/ --cov=. --cov-report=xml --cov-report=html

      # Django í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - echo "ğŸ”¬ Django í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
      - python manage.py test --parallel --keepdb --verbosity=2

      # íŒ¨í‚¤ì§€ ë¹Œë“œ
      - echo "ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±..."
      - python setup.py sdist bdist_wheel

      - echo "âœ… ë¹Œë“œ ì™„ë£Œ"

  # ë¹Œë“œ í›„ ì‘ì—…
  post_build:
    commands:
      - echo "ğŸ¯ ë¹Œë“œ í›„ ì‘ì—… ì‹œì‘..."

      # ë¬¸ì„œ ìƒì„±
      - echo "ğŸ“š ë¬¸ì„œ ìƒì„±..."
      - pip3 install sphinx sphinx-rtd-theme
      - sphinx-build -b html docs/ docs/_build/html

      # ë³´ì•ˆ ìŠ¤ìº”
      - echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬..."
      - safety check --json --output safety-report.json || true

      # ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      - echo "ğŸ“‹ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±..."
      - zip -r django-app-$(date +%Y%m%d%H%M%S).zip . \
          -x "*.git*" "__pycache__/*" "*.pyc" "tests/*" \
          "venv/*" ".pytest_cache/*" "htmlcov/*"

      - echo "âœ… ë¹Œë“œ í›„ ì‘ì—… ì™„ë£Œ"

# ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì„¤ì •
artifacts:
  files:
    # Python ë°°í¬ íŒŒì¼
    - 'dist/**/*'
    - 'django-app-*.zip'

    # Django í”„ë¡œì íŠ¸ íŒŒì¼
    - 'manage.py'
    - 'requirements.txt'
    - 'staticfiles/**/*'
    - 'media/**/*'

    # ë¬¸ì„œ ë° ë³´ê³ ì„œ
    - 'docs/_build/html/**/*'
    - 'htmlcov/**/*'
    - 'coverage.xml'
    - 'bandit-report.json'
    - 'safety-report.json'

    # ì„¤ì • íŒŒì¼
    - 'Procfile'
    - 'runtime.txt'
    - '.ebextensions/**/*'

  name: 'DjangoPythonAppArtifacts'
  base-directory: '.'

# ë¹Œë“œ ì†ë„ í–¥ìƒì„ ìœ„í•œ ìºì‹œ ì„¤ì •
cache:
  paths:
    # Python íŒ¨í‚¤ì§€ ìºì‹œ
    - '/root/.cache/pip/**/*'
    - '/root/.local/lib/python3.9/site-packages/**/*'

    # Python ì»´íŒŒì¼ ìºì‹œ
    - '__pycache__/**/*'
    - '.pytest_cache/**/*'
    - '.mypy_cache/**/*'

    # Node.js ìºì‹œ (Djangoì—ì„œ NPM ì‚¬ìš© ì‹œ)
    - 'node_modules/**/*'
    - '.npm/**/*'

    # ê¸°íƒ€ ë„êµ¬ ìºì‹œ
    - '.tox/**/*'
    - '.coverage'