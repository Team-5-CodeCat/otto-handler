// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// ==================== User & Auth ====================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  avatarUrl String?
  
  // GitHub OAuth Information (최소 스코프: read:user, user:email)
  githubId       String   @unique
  githubUsername String   @unique
  githubNodeId   String?  // GitHub's GraphQL node ID
  
  // User Status
  isActive  Boolean  @default(true)
  lastLoginAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  projects         Project[]
  pipelineTemplates PipelineTemplate[] @relation("TemplateCreator")
  sharedTemplates  PipelineTemplate[] @relation("SharedTemplates")
  sessions        Session[]
  installations   GithubInstallation[]
  
  @@index([githubId])
  @@index([githubUsername])
  @@map("users")
}
// ==================== Session Management ====================
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  
  // OAuth Token (암호화 저장, 짧은 TTL)
  accessToken  String?  @db.Text // 암호화된 GitHub OAuth token, 유저 정보 조회용
  tokenExpiresAt DateTime?
  
  // Session Data
  userAgent    String?
  ipAddress    String?
  
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([sessionToken])
  @@index([userId])
  @@map("sessions")
}
// ==================== GitHub App & Installation ====================
model GithubInstallation {
  id             String   @id @default(uuid())
  installationId String   @unique // GitHub Installation ID
  
  // GitHub App Installation Info
  appId          String   // GitHub App ID
  appSlug        String?  // GitHub App slug name
  targetType     String   // "User" or "Organization"
  targetId       String   // GitHub User/Org ID
  account        Json     // GitHub account info (login, avatar_url, etc.)
  
  // Installation Permissions & Events (리포지토리 작업용)
  permissions    Json     // Installation permissions (contents: read/write, metadata: read, pull_requests: write, etc.)
  events         String[] // Webhook events (push, pull_request, etc.)
  repositorySelection String @default("selected") // "all" or "selected"
  
  // Installation Token Management (암호화 저장) - 모든 리포지토리 작업용
  installationToken    String?  // 암호화된 installation token
  tokenExpiresAt       DateTime?
  privateKey           String   // 암호화된 GitHub App private key
  webhookSecret        String   // 암호화된 webhook secret
  
  // Installation Status
  isActive      Boolean  @default(true)
  suspendedAt   DateTime?
  suspendedBy   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projects  Project[]
  
  @@index([installationId])
  @@index([userId])
  @@map("github_installations")
}
// ==================== Project ====================
model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  
  // GitHub Repository Info
  githubRepoUrl    String
  githubRepoName   String
  githubOwner      String
  githubRepoId     String   // GitHub Repository ID
  defaultBranch    String   @default("main")
  isPrivate        Boolean  @default(true)
  
  // AWS Resources
  ecrRepositoryUri String?  // ECR Repository URI
  codeBuildProjectName String? // AWS CodeBuild project name
  
  // Deployment Configuration (암호화 저장)
  sshPrivateKey    String?  @db.Text // 암호화된 SSH private key
  sshPublicKey     String?  @db.Text // SSH public key
  deploymentConfig String?  @db.Text // 암호화된 deployment 설정 (server info, etc.)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  installationId String
  installation   GithubInstallation @relation(fields: [installationId], references: [id])
  
  pipelines Pipeline[]
  webhooks  Webhook[]
  secrets   ProjectSecret[]
  
  @@unique([githubOwner, githubRepoName])
  @@unique([githubRepoId])
  @@index([userId])
  @@index([installationId])
  @@map("projects")
}
// ==================== Secrets Management ====================
model ProjectSecret {
  id        String   @id @default(uuid())
  key       String
  value     String   @db.Text // 암호화된 값 저장
  isSecure  Boolean  @default(true) // 암호화 여부
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, key])
  @@map("project_secrets")
}
// ==================== Pipeline ====================
model Pipeline {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  
  // Pipeline Configuration
  triggerType TriggerType @default(MANUAL)
  triggerBranches String[] // branches to trigger on
  
  // Visual Pipeline Data
  pipelineYaml    String?  @db.Text // 사용자가 생성한 Pipeline YAML
  visualConfig    Json?    // Node 위치, 연결 정보 등 시각적 데이터
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  templateId String?
  template   PipelineTemplate? @relation(fields: [templateId], references: [id])
  
  nodes     PipelineNode[]
  executions PipelineExecution[]
  
  @@index([projectId])
  @@map("pipelines")
}
// ==================== Pipeline Template (for Asset Sharing) ====================
model PipelineTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String?  // e.g., "Node.js", "Python", "Docker"
  tags        String[]
  
  isPublic    Boolean  @default(false)
  isOfficial  Boolean  @default(false) // 공식 템플릿 여부
  
  // Template Data
  pipelineYaml  String   @db.Text // Template Pipeline YAML
  visualConfig  Json     // Node 구조 및 시각적 설정
  nodeConfig    Json     // Node들의 기본 설정값
  
  // Pre-generated Scripts (선택적)
  dockerfile    String?  @db.Text // 미리 생성된 Dockerfile
  dockerCompose String?  @db.Text // 미리 생성된 docker-compose.yaml
  buildSpec     Json?    // 미리 생성된 AWS CodeBuild buildspec
  
  // Docker Image Reference (optional)
  ecrImageUri String?  // Pre-built image in ECR
  imageVersion String?
  
  usageCount  Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  creatorId String
  creator   User     @relation("TemplateCreator", fields: [creatorId], references: [id])
  
  sharedWith User[]   @relation("SharedTemplates")
  pipelines  Pipeline[]
  
  @@index([isPublic, category])
  @@map("pipeline_templates")
}
// ==================== Pipeline Node ====================
model PipelineNode {
  id       String   @id @default(uuid())
  nodeId   String   // 클라이언트에서 생성한 고유 Node ID
  name     String   // e.g., "build", "test", "deploy"
  type     NodeType
  order    Int      // 실행 순서
  
  // Node Visual Info
  position Json?    // { x: 100, y: 200 } 좌표 정보
  
  // Node Configuration
  config   Json     // 상세 설정 (OS, 의존성, 명령어 등)
  // Example config:
  // {
  //   "image": "node:20",
  //   "os": "ubuntu:22.04",
  //   "commands": ["npm ci", "npm run build"],
  //   "dependencies": ["build-essential"],
  //   "environment": { "NODE_ENV": "production" },
  //   "artifacts": ["dist/**/*"],
  //   "cache": ["node_modules"]
  // }
  
  // Node Connection Info
  parentNodeIds String[] // 이전 노드 ID들 (병렬 처리 지원)
  childNodeIds  String[] // 다음 노드 ID들 (분기 처리 지원)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  pipelineId String
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  nodeExecutions NodeExecution[]
  
  @@unique([pipelineId, nodeId])
  @@index([pipelineId, order])
  @@map("pipeline_nodes")
}
// ==================== Pipeline Execution ====================
model PipelineExecution {
  id          String   @id @default(uuid())
  executionId String   @unique // AWS CodeBuild Build ID
  
  status      ExecutionStatus @default(PENDING)
  triggerType TriggerType
  branch      String?
  commitSha   String?
  commitMessage String?
  
  // Original Pipeline Data (실행 시점의 파이프라인 데이터)
  pipelineYaml    String   @db.Text // 실행된 Pipeline YAML
  
  // Generated Execution Scripts (클라이언트에서 변환된 스크립트)
  dockerfile      String?  @db.Text // 생성된 Dockerfile
  dockerCompose   String?  @db.Text // 생성된 docker-compose.yaml
  buildSpec       Json?    // 생성된 AWS CodeBuild buildspec.yml
  
  // AWS Resources
  codeBuildArn String?  // CodeBuild 실행 ARN
  codeBuildLogGroupName String? // CloudWatch Log Group
  codeBuildLogStreamName String? // CloudWatch Log Stream
  ecrImageUri  String?  // 생성된 Docker image URI
  ecrImageTag  String?  // Docker image tag
  
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?     // in seconds
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  pipelineId String
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  nodeExecutions NodeExecution[]
  logs          ExecutionLog[]
  deployments   Deployment[]
  
  @@index([pipelineId, status])
  @@index([executionId])
  @@map("pipeline_executions")
}
// ==================== Node Execution ====================
model NodeExecution {
  id        String   @id @default(uuid())
  
  status    ExecutionStatus @default(PENDING)
  startedAt DateTime?
  completedAt DateTime?
  duration  Int?     // in seconds
  
  // Execution Details
  output    String?  @db.Text
  error     String?  @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  executionId String
  execution   PipelineExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  
  nodeId    String
  node      PipelineNode @relation(fields: [nodeId], references: [id])
  
  @@index([executionId])
  @@map("node_executions")
}
// ==================== Deployment ====================
model Deployment {
  id        String   @id @default(uuid())
  
  status    DeploymentStatus @default(PENDING)
  
  // Deployment Target
  serverHost String
  serverPort Int      @default(22)
  deployPath String?
  
  // Deployment Strategy
  strategy   DeploymentStrategy @default(ROLLING)
  
  // Docker Info
  dockerImageUri String
  containerName  String?
  
  startedAt   DateTime?
  completedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  executionId String
  execution   PipelineExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  
  logs DeploymentLog[]
  
  @@index([executionId])
  @@map("deployments")
}
// ==================== Logs ====================
model ExecutionLog {
  id        String   @id @default(uuid())
  
  level     LogLevel @default(INFO)
  message   String   @db.Text
  source    String?  // e.g., "CodeBuild", "System"
  
  // S3 Reference for large logs
  s3Bucket  String?
  s3Key     String?
  
  timestamp DateTime @default(now())
  
  // Relations
  executionId String
  execution   PipelineExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  
  @@index([executionId, timestamp])
  @@map("execution_logs")
}
model DeploymentLog {
  id        String   @id @default(uuid())
  
  level     LogLevel @default(INFO)
  message   String   @db.Text
  source    String?  // e.g., "SSH", "Docker"
  
  // S3 Reference for large logs
  s3Bucket  String?
  s3Key     String?
  
  timestamp DateTime @default(now())
  
  // Relations
  deploymentId String
  deployment   Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  
  @@index([deploymentId, timestamp])
  @@map("deployment_logs")
}
// ==================== Webhook ====================
model Webhook {
  id        String   @id @default(uuid())
  
  eventType String   // e.g., "push", "pull_request"
  payload   Json     // GitHub webhook payload
  
  processed Boolean  @default(false)
  processedAt DateTime?
  
  createdAt DateTime @default(now())
  
  // Relations
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId, processed])
  @@map("webhooks")
}
// ==================== Enums ====================
enum TriggerType {
  MANUAL
  WEBHOOK
  SCHEDULE
  API
}
enum NodeType {
  BUILD
  TEST
  DEPLOY
  CUSTOM
}
enum ExecutionStatus {
  PENDING
  QUEUED
  RUNNING
  SUCCESS
  FAILED
  CANCELLED
  SKIPPED
}
enum DeploymentStatus {
  PENDING
  DEPLOYING
  SUCCESS
  FAILED
  ROLLED_BACK
}
enum DeploymentStrategy {
  ROLLING
  BLUE_GREEN
  CANARY
}
enum LogLevel {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}