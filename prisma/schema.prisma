// 데이터베이스: PostgreSQL
// 주요 기능: 사용자 인증, GitHub 연동, 프로젝트 관리, 환경 설정, 파이프라인, 실행, 작업, 로그, 상태/오류 관리
// 설계 원칙: Job/Log ID는 ULID (커스텀 함수), 나머지 UUID, 타임스탬프 정밀도 일관, 계층 구조 활용, JSON으로 확장성

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"] // 관계 쿼리 성능 최적화
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // 환경 변수에서 DB 연결 문자열 가져옴
}

// 사용자 역할 정의 (RBAC: 역할 기반 접근 제어)
enum MemberRole {
  ADMIN   // 관리자: 모든 권한
  MEMBER  // 일반 사용자: 기본 권한
  VIEWER  // 읽기 전용: 제한된 권한
}

// 지원 언어 정의 (MVP: Node, Python)
enum Language {
  NODE    // Node.js 환경
  PYTHON  // Python 환경
}

// 지원 배포 환경 정의 (MVP: EC2)
enum DeployEnvironment {
  EC2     // AWS EC2 인스턴스
}

// 작업 타입 정의 (빌드/테스트/배포 작업 구분)
enum JobType {
  BUILD       // 빌드 작업
  TEST        // 테스트 작업 (Unit/E2E)
  DEPLOYMENT  // 배포 작업
}

// 작업 상태 정의 (작업 라이프사이클 관리, 재시도 상태 포함)
enum JobStatus {
  pending     // 대기 중
  running     // 실행 중
  completed   // 완료
  failed      // 실패
  cancelled   // 취소됨
}

// 로그 스트림 정의 (stdout/stderr 구분, S3 연계 시 사용)
enum LogStream {
  stdout  // 표준 출력
  stderr  // 표준 에러
}

// 테스트 타입 정의 (테스트 작업 세분화)
enum TestType {
  UNIT    // 단위 테스트
  E2E     // End-to-End 테스트
}

// 사용자 정보: 인증 및 프로젝트 소유
model User {
  userID     String     @id @default(uuid()) @db.Uuid @map("user_id") // 기본 키, UUID로 고유성 보장
  email      String     @unique @map("email") // 고유 이메일, 로그인 식별자
  password   String     @map("password") // bcrypt로 암호화된 비밀번호
  name       String     @map("name") // 사용자 표시 이름
  memberRole MemberRole @default(MEMBER) @map("member_role") // 사용자 권한 역할, 기본 MEMBER
  createdAt  DateTime   @default(now()) @db.Timestamptz(6) @map("created_at") // 계정 생성 시각, 감사/UX용
  updatedAt  DateTime   @updatedAt @db.Timestamptz(6) @map("updated_at") // 마지막 수정 시각, 변경 추적

  // 관계
  projects Project[] // 사용자가 소유한 프로젝트들 (일대다)
  github   Github?   // GitHub 계정 연결 정보 (일대일, 선택적)
  refreshTokens RefreshToken[] // 리프레쉬 토큰

  @@map("users") // DB 테이블 이름: users
}


model RefreshToken {
  tokenId    String   @id @default(uuid()) @db.Uuid @map("token_id")
  userID     String   @db.Uuid @map("user_id")
  token      String   @unique @map("token")
  expiresAt  DateTime @map("expires_at")
  lastUsedAt DateTime @default(now()) @map("last_used_at")
  createdAt  DateTime @default(now()) @map("created_at")


  // 관계
  user User @relation(fields: [userID], references: [userID], onDelete: Cascade)

  @@map("refresh_tokens")
}


// GitHub 앱 설치 정보: GitHub App 설치 및 인증
model Github {
  userID         String  @id @db.Uuid @map("user_id") // 기본 키, User.userID와 동일 (UUID)
  installationId String  @unique @map("installation_id") // GitHub App 설치 ID
  accessToken    String  @map("access_token") // GitHub App 액세스 토큰
  createdAt      DateTime @default(now()) @db.Timestamptz(6) @map("created_at") // 설치 시각
  updatedAt      DateTime @updatedAt @db.Timestamptz(6) @map("updated_at") // 마지막 업데이트 시각

  // 관계
  user User @relation(fields: [userID], references: [userID], onDelete: Cascade) // 사용자 삭제 시 연쇄 삭제

  @@map("github") // DB 테이블 이름: github
}

// 프로젝트-레포지토리 연결: 프로젝트와 GitHub 레포지토리 연결
model ProjectRepository {
  id              String   @id @default(uuid()) @db.Uuid @map("id") // 기본 키, UUID
  projectID       String   @db.Uuid @map("project_id") // 소속 프로젝트 ID
  repoFullName    String   @map("repo_full_name") // 레포지토리 전체 이름 (owner/repo)
  selectedBranch  String   @map("selected_branch") // 선택된 브랜치
  isActive        Boolean  @default(true) @map("is_active") // 활성 상태
  createdAt       DateTime @default(now()) @db.Timestamptz(6) @map("created_at") // 생성 시각
  updatedAt       DateTime @updatedAt @db.Timestamptz(6) @map("updated_at") // 수정 시각

  // 관계
  project Project @relation(fields: [projectID], references: [projectID], onDelete: Cascade) // 프로젝트 삭제 시 연쇄 삭제

  @@unique([projectID, repoFullName]) // 프로젝트당 레포지토리 고유성
  @@index([projectID]) // 프로젝트별 조회 최적화
  @@map("project_repositories") // DB 테이블 이름: project_repositories
}

// 프로젝트: 사용자별 CI/CD 작업 단위
model Project {
  projectID  String    @id @default(uuid()) @db.Uuid @map("project_id") // 기본 키, UUID
  userID     String    @db.Uuid @map("user_id") // 소유자 ID (UUID 참조)
  name       String    @map("name") // 프로젝트 표시 이름
  webhookUrl String?   @unique @map("webhook_url") // GitHub webhook URL (선택적, 고유)
  createdAt  DateTime  @default(now()) @db.Timestamptz(6) @map("created_at") // 생성 시각
  updatedAt  DateTime  @updatedAt @db.Timestamptz(6) @map("updated_at") // 수정 시각

  // 관계
  user         User                @relation(fields: [userID], references: [userID], onDelete: Cascade) // 사용자 삭제 시 연쇄 삭제
  pipelines    Pipeline[]          // 프로젝트에 속한 파이프라인들
  environments Environment[]       // 프로젝트 환경 설정들
  repositories ProjectRepository[] // 프로젝트에 연결된 레포지토리들

  @@map("projects") // DB 테이블 이름: projects
}

// 환경 설정: 언어, 배포 환경, 환경 변수, 인증 정보
model Environment {
  environmentID    String            @id @default(uuid()) @db.Uuid @map("environment_id") // 기본 키, UUID
  projectID        String            @db.Uuid @map("project_id") // 소속 프로젝트 ID (UUID 참조)
  language         Language          @map("language") // 프로그래밍 언어 (Node/Python)
  deployEnv        DeployEnvironment @map("deploy_environment") // 배포 환경 (EC2)
  envVariables     Json?             @map("env_variables") // 환경 변수 (JSON, 예: {"NODE_ENV": "production"})
  credentials      Json?             @map("credentials") // 인증 정보 (JSON, 암호화 권장)
  deploymentTarget String?           @map("deployment_target") // 배포 대상 (IP, 도메인)
  deploymentPath   String?           @map("deployment_path") // 서버 내 배포 경로
  servicePort      Int?              @map("service_port") // 서비스 실행 포트
  createdAt        DateTime          @default(now()) @db.Timestamptz(6) @map("created_at") // 생성 시각
  updatedAt        DateTime          @updatedAt @db.Timestamptz(6) @map("updated_at") // 수정 시각

  // 관계
  project Project @relation(fields: [projectID], references: [projectID], onDelete: Cascade) // 프로젝트 삭제 시 연쇄 삭제

  @@map("environments") // DB 테이블 이름: environments
}

// 파이프라인: 빌드/테스트/배포 워크플로우 정의
model Pipeline {
  pipelineID    String    @id @default(uuid()) @db.Uuid @map("pipeline_id") // 기본 키, UUID
  projectID     String    @db.Uuid @map("project_id") // 소속 프로젝트 ID (UUID 참조)
  name          String    @map("name") // 파이프라인 이름
  version       Int       @default(1) @map("version") // 버전 관리, 기본 1
  active        Boolean   @default(true) @map("active") // 활성 여부
  owner         String?   @map("owner") // 소유자 정보 (선택적, 사용자 이름/ID)
  pipelineSpec  Json      @map("pipeline_spec") // YAML/Shell 또는 PaB 설정 (JSON)
  isBlockBased  Boolean   @default(false) @map("is_block_based") // PaB 방식 여부
  createdAt     DateTime  @default(now()) @db.Timestamptz(6) @map("created_at") // 생성 시각
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6) @map("updated_at") // 수정 시각

  // 관계
  project Project       @relation(fields: [projectID], references: [projectID], onDelete: Cascade) // 프로젝트 삭제 시 연쇄 삭제
  runs    PipelineRun[] // 파이프라인 실행 인스턴스들

  @@unique([name, version]) // 이름과 버전으로 고유성 보장
  @@index([owner]) // 소유자 기반 조회 최적화
  @@index([projectID]) // 프로젝트별 조회 최적화
  @@map("pipelines") // DB 테이블 이름: pipelines
}

// 파이프라인 실행 인스턴스: 특정 시점의 파이프라인 실행
model PipelineRun {
  id              String    @id @default(uuid()) @db.Uuid @map("id") // 기본 키, UUID
  pipelineID      String    @db.Uuid @map("pipeline_id") // 소속 파이프라인 ID (UUID 참조)
  pipelineVersion Int       @map("pipeline_version") // 실행 시점의 파이프라인 버전
  status          JobStatus @map("status") // 실행 상태
  createdAt       DateTime  @default(now()) @db.Timestamptz(6) @map("created_at") // 생성 시각
  queuedAt        DateTime? @db.Timestamptz(6) @map("queued_at") // 대기 시작 시각
  startedAt       DateTime? @db.Timestamptz(6) @map("started_at") // 시작 시각
  finishedAt      DateTime? @db.Timestamptz(6) @map("finished_at") // 완료 시각
  exitCode        Int?      @map("exit_code") // 종료 코드 (오류 분석)
  owner           String?   @map("owner") // 실행 요청자
  agent           String?   @map("agent") // 실행 에이전트 (서버/컨테이너)
  containerImage  String?   @map("container_image") // 컨테이너 이미지
  trigger         String?   @map("trigger") // 트리거 정보 (webhook, manual)
  labels          Json?     @map("labels") // 레이블 (메타데이터)
  metadata        Json?     @map("metadata") // 추가 메타데이터
  externalRunKey  String?   @unique @map("external_run_key") // 외부 실행 키 (고유)

  // 관계
  pipeline Pipeline @relation(fields: [pipelineID], references: [pipelineID], onDelete: Restrict) // 실행 중 삭제 방지
  jobs     Job[] // 실행에 포함된 작업들

  @@index([pipelineID, createdAt(sort: Desc)]) // 파이프라인별 최근 실행 조회 최적화
  @@index([status, createdAt(sort: Desc)]) // 상태별 최근 실행 조회 최적화
  @@map("pipeline_runs") // DB 테이블 이름: pipeline_runs
}

// 개별 작업: 빌드/테스트/배포 등 구체적 작업 단위
model Job {
  id              String      @id @default(uuid()) @db.Uuid @map("id") // 실제 삽입할 때 ULID 생성
  runID           String      @db.Uuid @map("run_id") // 소속 실행 ID (UUID 참조)
  name            String      @map("name") // 작업 이름
  type            JobType     @map("type") // 작업 타입 (BUILD/TEST/DEPLOYMENT)
  testType        TestType?   @map("test_type") // 테스트 타입 (TEST일 때 사용)
  status          JobStatus   @map("status") // 작업 상태 (재시도 상태 포함)
  attemptCurrent  Int         @default(0) @map("attempt_current") // 현재 재시도 횟수
  attemptMax      Int         @default(3) @map("attempt_max") // 최대 재시도 횟수
  exitCode        Int?        @map("exit_code") // 종료 코드
  envVariables    Json?       @map("env_variables") // 작업별 환경 변수 (런타임 주입)
  s3ArtifactUrl   String?     @map("s3_artifact_url") // S3 결과물 URL
  targetUrl       String?     @map("target_url") // 배포 대상 URL (DEPLOYMENT용)
  createdAt       DateTime    @default(now()) @db.Timestamptz(6) @map("created_at") // 생성 시각
  queuedAt        DateTime?   @db.Timestamptz(6) @map("queued_at") // 대기 시작
  startedAt       DateTime?   @db.Timestamptz(6) @map("started_at") // 시작
  finishedAt      DateTime?   @db.Timestamptz(6) @map("finished_at") // 완료
  owner           String?     @map("owner") // 소유자
  agent           String?     @map("agent") // 에이전트
  containerImage  String?     @map("container_image") // 컨테이너 이미지
  command         String?     @map("command") // 실행 명령어
  inputs          Json?       @map("inputs") // 입력 데이터
  outputs         Json?       @map("outputs") // 출력 결과
  externalJobKey  String?     @unique @map("external_job_key") // 외부 작업 키

  // 관계
  run          PipelineRun      @relation(fields: [runID], references: [id], onDelete: Cascade) // 실행 삭제 시 연쇄 삭제
  statusEvents JobStatusEvent[] // 상태 변화 이벤트
  errors       JobError[]       // 실행 오류
  logs         Log[]            // 실행 로그

  @@unique([runID, name]) // 실행 내 작업 이름 고유성
  @@index([runID, createdAt(sort: Desc)]) // 실행별 최근 작업 조회
  @@index([status, createdAt(sort: Desc)]) // 상태별 최근 작업 조회
  @@index([type, createdAt(sort: Desc)]) // 타입별 최근 작업 조회
  @@index([agent]) // 에이전트별 조회
  @@map("jobs") // DB 테이블 이름: jobs
}

// 작업 상태 이벤트: 상태 변화 추적
model JobStatusEvent {
  id         String     @id @default(uuid()) @db.Uuid @map("id") // 기본 키, UUID
  jobID      String     @db.Uuid @map("job_id") // 소속 작업 ID (ULID 참조)
  fromStatus JobStatus? @map("from_status") // 이전 상태 (선택적)
  toStatus   JobStatus  @map("to_status") // 현재 상태
  reason     String?    @map("reason") // 상태 변경 사유
  data       Json?      @map("data") // 추가 데이터
  at         DateTime   @default(now()) @db.Timestamptz(6) @map("at") // 이벤트 시각

  // 관계
  job Job @relation(fields: [jobID], references: [id], onDelete: Cascade) // 작업 삭제 시 연쇄 삭제

  @@index([jobID, at(sort: Desc)]) // 작업별 최근 이벤트 조회
  @@map("job_status_events") // DB 테이블 이름: job_status_events
}

// 작업 오류: 실행 중 발생한 오류 기록
model JobError {
  id         String    @id @default(uuid()) @db.Uuid @map("id") // 기본 키, UUID
  jobID      String    @db.Uuid @map("job_id") // 소속 작업 ID (ULID 참조)
  attemptNo  Int       @map("attempt_no") // 재시도 번호
  occurredAt DateTime  @default(now()) @db.Timestamptz(6) @map("occurred_at") // 발생 시각
  errorType  String?   @map("error_type") // 오류 유형
  message    String?   @db.VarChar(4096) @map("message") // 오류 메시지
  stacktrace String?   @db.VarChar(8192) @map("stacktrace") // 스택 트레이스
  context    Json?     @map("context") // 맥락 데이터
  dedupeKey  String?   @unique @map("dedupe_key") // 중복 제거 키

  // 관계
  job Job @relation(fields: [jobID], references: [id], onDelete: Cascade) // 작업 삭제 시 연쇄 삭제

  @@index([jobID, attemptNo]) // 작업/재시도별 조회
  @@index([occurredAt(sort: Desc)]) // 최근 오류 조회
  @@index([errorType]) // 오류 타입별 조회
  @@map("job_errors") // DB 테이블 이름: job_errors
}

// 로그: 작업 실행 중 생성되는 로그 정보
model Log {
  logID         String     @id @default(uuid()) @db.Uuid @map("log_id") // 실제 삽입할 때 ULID 생성
  jobID         String     @db.Uuid @map("job_id") // 소속 작업 ID (ULID 참조)
  attemptNo     Int        @map("attempt_no") // 재시도 번호
  stream        LogStream  @map("stream") // 로그 스트림 (stdout/stderr)
  content       String?    @map("content") // 내부 로그 내용 (짧은 로그)
  storageBucket String?    @map("storage_bucket") // S3 버킷 (긴 로그)
  storageKey    String?    @map("storage_key") // S3 키
  sizeBytes     BigInt?    @db.BigInt @map("size_bytes") // 로그 크기 (바이트)
  contentType   String?    @map("content_type") // 콘텐츠 타입 (e.g., text/plain)
  createdAt     DateTime   @default(now()) @db.Timestamptz(6) @map("created_at") // 생성 시각 (TTL 기준)

  // 관계
  job Job @relation(fields: [jobID], references: [id], onDelete: Cascade) // 작업 삭제 시 연쇄 삭제

  @@unique([jobID, attemptNo, stream]) // 작업/재시도/스트림별 고유성
  @@index([jobID, attemptNo]) // 작업/재시도별 조회
  @@index([createdAt(sort: Desc)]) // 최근 로그 조회 (TTL 관리)
  @@map("logs") // DB 테이블 이름: logs
}